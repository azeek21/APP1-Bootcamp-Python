import pathlib
from bs4 import BeautifulSoup

def get_doc(filepath: str) -> BeautifulSoup:
    try:
        with open(filepath) as file:
            soup = BeautifulSoup(file, 'lxml')
        return soup
    except Exception as e:
        print("FATAL ! SOMETHING WENT WRONG >>>\n", e)
        return None


def replace_title_inner(doc: BeautifulSoup) -> bool:
    try:
        titles = doc.head.find_all('title')
        if titles:
            for i in titles:
                i.string = "Evil Corp - Stealing your money every day"
        else:
            new_title = doc.new_tag('title')
            new_title.string = "Evil Corp - Stealing your money every day"
            doc.head.append(new_title)
        return True
    except Exception as e:
        print(e)
        return False
    

def inject_new_welcome(doc: BeautifulSoup) -> bool:

    try:
        pronoun = doc.find('span', {'class': 'pronoun'}).string
    except:
        pronoun = ""
    
    try:
        name = doc.find('span', {'class': 'name'}).contents[-1]
    except:
        name = ""

    try:
        new_welcome = doc.new_tag('h1')
        new_welcome.string = f"{pronoun}{name}, you are hacked"
        doc.body.insert(2, new_welcome)
        return True
    except Exception as e:
        print(e)
        return False


def inject_script(doc: BeautifulSoup) -> bool:
    try:
        script = doc.new_tag('script')
        script.string = """
        hacked=function(){alert("hacked")},window.addEventListener("load",function(){document.querySelector("form").setAttribute("onsubmit","hacked()")},!1);
        """
        doc.body.append(script)
        return True
    except Exception as e:
        print(e)
        return False

def fix_bottom_link(doc: BeautifulSoup) -> bool:
    try:
        link = doc.body.find_all('a')[-1] 
        link['href'] = "https://mrrobot.fandom.com/wiki/Fsociety"
        link.string = "Fsociety"
        return True
    except Exception as e:
        print(e)
        return False



def main():
    c_path = pathlib.Path.cwd()
    filepath = c_path.parent.parent.joinpath('materials', 'evilcorp.html')
    destination = filepath.parent.joinpath( "evilcorp_hacked.html")

    doc = get_doc(filepath)

    if not doc:
        exit(1)

    if replace_title_inner(doc) and\
        inject_new_welcome(doc) and\
        inject_script(doc) and\
        fix_bottom_link(doc):
        with open(destination, 'w', encoding="utf-8") as file:
            file.write(str(doc))
        print(f"DONE: result saved to -> \n{destination}\npress command + link above to see...")
    else:
        # print("You f.ed up")
        exit(1)




if __name__ == "__main__":
    main()
